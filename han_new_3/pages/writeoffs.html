<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ø–∏—Å–∞–Ω–∏—è - HAN CRM</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/writeoffs.css">
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar">
        <div class="nav-brand">
            <h1>üåª HAN CRM</h1>
        </div>
        <div class="nav-menu">
            <a href="dashboard.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="sales.html">–ü—Ä–æ–¥–∞–∂–∏</a>
            <a href="clients.html">–ö–ª–∏–µ–Ω—Ç—ã</a>
            <a href="products.html">–¢–æ–≤–∞—Ä—ã</a>
            <a href="production.html" data-role="manager,admin">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</a>
            <a href="writeoffs.html" class="active" data-role="manager,admin">–°–ø–∏—Å–∞–Ω–∏—è</a>
            <a href="stock.html" data-role="manager,admin">–°–∫–ª–∞–¥</a>
            <a href="reports.html" data-role="manager,admin">–û—Ç—á—ë—Ç—ã</a>
        </div>
        <div class="nav-user">
            <span id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
            <button onclick="logout()" class="btn-logout">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="page-header">
            <div>
                <h2>–°–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤</h2>
                <p class="page-subtitle">–£—á—ë—Ç –±—Ä–∞–∫–∞, –ø–æ—Ä—á–∏ –∏ –¥—Ä—É–≥–∏—Ö –ø–æ—Ç–µ—Ä—å</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-secondary" onclick="writeoffsPage.exportToExcel()">
                    üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </button>
                <button class="btn btn-danger" onclick="writeoffsPage.openCreateModal()">
                    ‚ûï –°–ø–∏—Å–∞—Ç—å —Ç–æ–≤–∞—Ä
                </button>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters-panel">
            <div class="filter-group">
                <label>–ü–µ—Ä–∏–æ–¥:</label>
                <input type="date" id="dateFrom" class="form-control">
                <span>‚Äî</span>
                <input type="date" id="dateTo" class="form-control">
            </div>

            <div class="filter-group">
                <label>–¢–∏–ø —Å–ø–∏—Å–∞–Ω–∏—è:</label>
                <select id="typeFilter" class="form-control">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="defect">–ë—Ä–∞–∫</option>
                    <option value="expired">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</option>
                    <option value="damage">–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>

            <div class="filter-group">
                <label>–¢–æ–≤–∞—Ä:</label>
                <select id="productFilter" class="form-control">
                    <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                </select>
            </div>

            <button class="btn btn-secondary" onclick="writeoffsPage.applyFilters()">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
            <button class="btn btn-secondary" onclick="writeoffsPage.resetFilters()">
                –°–±—Ä–æ—Å–∏—Ç—å
            </button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-info">
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                    <div class="stat-value" id="statTotal">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-info">
                    <div class="stat-label">–°–ø–∏—Å–∞–Ω–æ (—à—Ç)</div>
                    <div class="stat-value" id="statQuantity">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ùå</div>
                <div class="stat-info">
                    <div class="stat-label">–ë—Ä–∞–∫</div>
                    <div class="stat-value" id="statDefect">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è∞</div>
                <div class="stat-info">
                    <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</div>
                    <div class="stat-value" id="statExpired">0</div>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Å–ø–∏—Å–∞–Ω–∏–π -->
        <div class="card">
            <div class="table-container">
                <table class="data-table" id="writeoffsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–¢–∏–ø</th>
                            <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                            <th>–°–æ–∑–¥–∞–ª</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="writeoffsTableBody">
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="loader"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            <div class="pagination" id="pagination"></div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
    <div id="writeoffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–°–ø–∏—Å–∞—Ç—å —Ç–æ–≤–∞—Ä</h3>
                <button class="modal-close" onclick="writeoffsPage.closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="writeoffForm">
                    <div class="form-group">
                        <label for="productSelect">–¢–æ–≤–∞—Ä <span class="required">*</span></label>
                        <div class="product-search-wrapper">
                            <input 
                                type="text" 
                                id="productSearch" 
                                class="form-control" 
                                placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..."
                            >
                            <select id="productSelect" class="form-control" required style="display: none;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
                            </select>
                        </div>
                        <div id="productSearchResults" class="search-results"></div>
                        <div id="selectedProductInfo" class="selected-product-info" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label for="writeoffQuantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç) <span class="required">*</span></label>
                        <input 
                            type="number" 
                            id="writeoffQuantity" 
                            class="form-control" 
                            min="1"
                            placeholder="0"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="writeoffType">–¢–∏–ø —Å–ø–∏—Å–∞–Ω–∏—è <span class="required">*</span></label>
                        <select id="writeoffType" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="defect">–ë—Ä–∞–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</option>
                            <option value="expired">–ò—Å—Ç—ë–∫ —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏</option>
                            <option value="damage">–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —É–ø–∞–∫–æ–≤–∫–∏</option>
                            <option value="other">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="writeoffReason">–ü—Ä–∏—á–∏–Ω–∞ <span class="required">*</span></label>
                        <textarea 
                            id="writeoffReason" 
                            class="form-control" 
                            rows="3" 
                            placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã —Å–ø–∏—Å–∞–Ω–∏—è..."
                            required
                        ></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="writeoffsPage.closeModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button class="btn btn-danger" onclick="writeoffsPage.saveWriteoff()">
                    –°–ø–∏—Å–∞—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script type="module" src="../js/pages/writeoffs.js"></script>
    <script>
        function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user');
                window.location.href = '../login.html';
            }
        }
    </script>
</body>
</html>